version: '3.8'

services:
  # OT Simulator - Generates test data
  ot_simulator:
    build:
      context: .
      dockerfile: Dockerfile.simulator
    container_name: ot-simulator
    ports:
      - "4840:4840"    # OPC-UA
      - "1883:1883"    # MQTT
      - "5020:5020"    # Modbus TCP
      - "8989:8989"    # Web UI
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    volumes:
      - ./ot_simulator:/app/ot_simulator
      - ./ot_simulator/config.yaml:/app/config.yaml
    networks:
      - iot_network
    restart: unless-stopped
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Unified Connector - Ingests data to Databricks
  unified_connector:
    build:
      context: .
      dockerfile: unified_connector/Dockerfile
    container_name: unified-connector
    ports:
      - "8080:8080"    # Web UI
      - "8081:8081"    # Health check
      - "9090:9090"    # Prometheus metrics
    environment:
      - PYTHONUNBUFFERED=1
      - CONNECTOR_LOG_LEVEL=INFO
      - CONNECTOR_MASTER_PASSWORD=${CONNECTOR_MASTER_PASSWORD:-changeme123}
      # ZeroBus credentials (optional, can be set via Web UI)
      - CONNECTOR_ZEROBUS_CLIENT_ID=${CONNECTOR_ZEROBUS_CLIENT_ID:-}
      - CONNECTOR_ZEROBUS_CLIENT_SECRET=${CONNECTOR_ZEROBUS_CLIENT_SECRET:-}
    volumes:
      - ./unified_connector:/app/unified_connector
      - ./unified_connector/config:/app/config
      - connector_data:/data
      - connector_credentials:/home/connector/.unified_connector
    networks:
      - iot_network
    depends_on:
      - ot_simulator
    restart: unless-stopped
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  iot_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  connector_data:
    driver: local
  connector_credentials:
    driver: local
