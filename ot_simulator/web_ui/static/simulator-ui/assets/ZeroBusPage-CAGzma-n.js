import{u as P,r as n,j as s,P as k,F as g,a as O,T as b,B as h}from"./index-BaPJlJ0v.js";import{s as f}from"./simApi-GdAodEFA.js";function A(){const a=P(),[o,B]=n.useState("opcua"),[v,_]=n.useState(null),[y,x]=n.useState(!1),[p,l]=n.useState(!1),[r,c]=n.useState({}),[T,u]=n.useState("");function S(e){const t=(e||"").split(".").map(d=>d.trim()).filter(Boolean);return t.length!==3?null:{catalog:t[0],schema:t[1],table:t[2]}}const L=n.useMemo(()=>{const e=r?.target??{},t=String(e?.catalog??""),d=String(e?.schema??""),m=String(e?.table??"");return[t,d,m].filter(Boolean).join(".")},[r]),E=n.useCallback(e=>{const t=S(e);t&&c(d=>({...d,target:{...d?.target??{},...t}}))},[]),i=n.useCallback(async()=>{try{_(await f.zeroBusStatus())}catch(e){a.show(e instanceof Error?e.message:"Failed to load status","bad")}},[a]),j=n.useCallback(async()=>{x(!0);try{const e=await f.loadZeroBusConfig(o);e?.success?(c(e.config??{}),u("Loaded saved config"),a.show("Loaded saved config","ok")):(u(String(e?.message??"No saved config")),a.show(String(e?.message??"No saved config"),"warn"))}catch(e){a.show(e instanceof Error?e.message:"Failed to load config","bad")}finally{x(!1)}},[o,a]);n.useEffect(()=>{i().catch(()=>{}),j().catch(()=>{})},[o]);const N=n.useCallback(async()=>{l(!0);try{const e=await f.saveZeroBusConfig(o,r);u(JSON.stringify(e,null,2)),a.show(String(e?.message??"Saved"),e?.success===!1?"warn":"ok"),await i()}catch(e){a.show(e instanceof Error?e.message:"Save failed","bad")}finally{l(!1)}},[r,o,i,a]),Z=n.useCallback(async()=>{l(!0);try{const e=await f.testZeroBus(o,r);u(JSON.stringify(e,null,2)),a.show(String(e?.message??"Test complete"),e?.success===!1?"warn":"ok")}catch(e){a.show(e instanceof Error?e.message:"Test failed","bad")}finally{l(!1)}},[r,o,a]),q=n.useCallback(async()=>{l(!0);try{const e=await f.startZeroBus(o);u(JSON.stringify(e,null,2)),a.show(String(e?.message??"Start requested"),e?.success===!1?"warn":"ok"),await i()}catch(e){a.show(e instanceof Error?e.message:"Start failed","bad")}finally{l(!1)}},[o,i,a]),F=n.useCallback(async()=>{l(!0);try{const e=await f.stopZeroBus(o);u(JSON.stringify(e,null,2)),a.show(String(e?.message??"Stop requested"),e?.success===!1?"warn":"ok"),await i()}catch(e){a.show(e instanceof Error?e.message:"Stop failed","bad")}finally{l(!1)}},[o,i,a]),w=!!v?.status?.[o]?.has_config,C=!!v?.status?.[o]?.active;return s.jsxs("div",{style:{display:"grid",gap:16},children:[s.jsx(k,{title:"ZeroBus",subtitle:"Per-protocol configuration + start/stop/test",actions:s.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[s.jsx(h,{type:"button",onClick:()=>i(),disabled:y||p,children:"Refresh status"}),s.jsx(h,{type:"button",onClick:()=>j(),disabled:y,children:y?"Loading...":"Load saved"}),s.jsx(h,{variant:"primary",type:"button",onClick:()=>N(),disabled:p,children:"Save"}),s.jsx(h,{type:"button",onClick:()=>Z(),disabled:p,children:"Test"}),s.jsx(h,{variant:"primary",type:"button",onClick:()=>q(),disabled:p||!w,children:"Start streaming"}),s.jsx(h,{variant:"danger",type:"button",onClick:()=>F(),disabled:p||!C,children:"Stop streaming"})]}),children:s.jsxs("div",{style:{display:"grid",gap:10},children:[s.jsx(g,{label:"Protocol",children:s.jsxs(O,{value:o,onChange:e=>B(e.target.value),children:[s.jsx("option",{value:"opcua",children:"OPC-UA"}),s.jsx("option",{value:"mqtt",children:"MQTT"}),s.jsx("option",{value:"modbus",children:"Modbus"})]})}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[s.jsx(g,{label:"Workspace host",children:s.jsx(b,{value:String(r?.workspace_host??""),onChange:e=>c(t=>({...t,workspace_host:e.target.value})),placeholder:"https://adb-..."})}),s.jsx(g,{label:"ZeroBus endpoint",children:s.jsx(b,{value:String(r?.zerobus_endpoint??""),onChange:e=>c(t=>({...t,zerobus_endpoint:e.target.value})),placeholder:"<workspaceId>.zerobus.<region>.cloud.databricks.com"})})]}),s.jsx(g,{label:"Target table (catalog.schema.table)",children:s.jsx(b,{value:L,onChange:e=>{const t=e.target.value;c(m=>({...m,__table_fqn_draft:t})),S(t)&&E(t)},placeholder:"main.iot_data.sensor_readings"})}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[s.jsx(g,{label:"Client ID",children:s.jsx(b,{value:String(r?.auth?.client_id??""),onChange:e=>c(t=>({...t,auth:{...t?.auth??{},client_id:e.target.value}}))})}),s.jsx(g,{label:"Client secret",children:s.jsx(b,{type:"password",value:String(r?.auth?.client_secret??""),onChange:e=>c(t=>({...t,auth:{...t?.auth??{},client_secret:e.target.value}}))})})]}),s.jsxs("div",{className:"muted",children:["Status: ",C?"streaming active":"inactive","; saved config: ",w?"yes":"no"]})]})}),s.jsx(k,{title:"Last result",subtitle:"Raw response",children:s.jsx("pre",{className:"kvs",style:{margin:0},children:s.jsx("code",{style:{color:"var(--text-primary)"},children:T||"â€”"})})})]})}export{A as ZeroBusPage};
