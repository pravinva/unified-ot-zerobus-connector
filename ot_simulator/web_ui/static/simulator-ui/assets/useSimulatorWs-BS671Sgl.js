import{r as e}from"./index-D7osG2pV.js";function k(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`}function R(){const[i,p]=e.useState(!1),[d,b]=e.useState(null),[f,m]=e.useState(null),[w,g]=e.useState({}),[S,y]=e.useState([]),n=e.useRef(null),c=e.useRef(null),a=e.useRef(400),l=e.useCallback(()=>{if(n.current&&(n.current.readyState===WebSocket.OPEN||n.current.readyState===WebSocket.CONNECTING))return;const t=new WebSocket(k());n.current=t,t.onopen=()=>{p(!0),a.current=400,t.send(JSON.stringify({type:"get_status"}))},t.onclose=()=>{p(!1),n.current=null;const s=Math.min(8e3,a.current);a.current=Math.min(8e3,a.current*1.7),c.current&&window.clearTimeout(c.current),c.current=window.setTimeout(()=>l(),s)},t.onerror=()=>{},t.onmessage=s=>{try{const o=JSON.parse(s.data);b(o),o?.type==="status_update"&&m(o),o?.type==="sensor_data"&&g(o?.sensors??{}),o?.type==="nlp_response"&&y(N=>[...N.slice(-199),{ts:Date.now(),direction:"in",payload:o}])}catch{}}},[]);e.useEffect(()=>(l(),()=>{c.current&&window.clearTimeout(c.current),n.current?.close()}),[l]);const r=e.useCallback(t=>{const s=n.current;return!s||s.readyState!==WebSocket.OPEN?!1:(s.send(JSON.stringify(t)),!0)},[]),u=e.useCallback(t=>(y(s=>[...s.slice(-199),{ts:Date.now(),direction:"out",payload:{text:t}}]),r({type:"nlp_command",text:t})),[r]);return e.useMemo(()=>({connected:i,lastMessage:d,status:f,sensorData:w,nlpLog:S,subscribe:t=>r({type:"subscribe",sensors:t}),unsubscribe:t=>r({type:"unsubscribe",sensors:t}),getStatus:()=>r({type:"get_status"}),setUpdateRate:t=>r({type:"set_update_rate",interval:t}),sendNlpCommand:u,startProtocol:t=>u(`start ${t}`),stopProtocol:t=>u(`stop ${t}`)}),[i,d,S,r,u,w,f])}export{R as u};
