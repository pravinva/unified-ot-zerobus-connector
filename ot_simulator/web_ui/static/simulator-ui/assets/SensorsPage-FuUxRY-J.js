import{r as i,j as e,u as B,P as C,S as M,B as N,F as P,a as z,T as O}from"./index-D7osG2pV.js";import{s as $}from"./simApi-GdAodEFA.js";import{u as Y}from"./useSimulatorWs-BS671Sgl.js";const E=["#00ff41","#00a8e1","#ffaa00","#4a9eff","#ff3621","#c77dff","#2dd4bf","#f472b6"];function D(a,l,x){return Math.max(l,Math.min(x,a))}function L(a){if(typeof a!="number"||!Number.isFinite(a))return"—";const l=Math.abs(a);return l>=1e3?a.toFixed(0):l>=10?a.toFixed(1):a.toFixed(2)}function V(a){const l=a.height??260,x=a.maxPoints??240,u=i.useMemo(()=>{const t=a.series.map((c,h)=>({...c,color:c.color??E[h%E.length],values:c.values.slice(-x)}));let r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(const c of t)for(const h of c.values)Number.isFinite(h)&&(r=Math.min(r,h),o=Math.max(o,h));return(!Number.isFinite(r)||!Number.isFinite(o))&&(r=0,o=1),r===o&&(r-=1,o+=1),{series:t,min:r,max:o}},[x,a.series]),b=1e3,p=24,y=18,v=b-p*2,g=l-y*2,k=t=>{const r=(t-u.min)/(u.max-u.min);return y+(1-D(r,0,1))*g},S=(t,r)=>r<=1?p:p+t/(r-1)*v,j=6;return e.jsxs("div",{style:{display:"grid",gap:10},children:[e.jsx("div",{style:{border:"1px solid var(--border-panel)",borderRadius:2,background:"rgba(0,0,0,0.35)",overflow:"hidden"},children:e.jsxs("svg",{viewBox:`0 0 ${b} ${l}`,width:"100%",height:l,preserveAspectRatio:"none",children:[Array.from({length:j+1}).map((t,r)=>{const o=y+r/j*g,c=u.max-r/j*(u.max-u.min);return e.jsxs("g",{children:[e.jsx("line",{x1:p,x2:p+v,y1:o,y2:o,stroke:"rgba(255,255,255,0.06)",strokeWidth:"1"}),e.jsx("text",{x:6,y:o+4,fill:"rgba(255,255,255,0.45)",fontSize:"18",fontFamily:"var(--font-data)",children:L(c)})]},r)}),u.series.map(t=>{const r=t.values.length;if(r<2)return null;const o=t.values.map((c,h)=>`${h===0?"M":"L"} ${S(h,r)} ${k(c)}`).join(" ");return e.jsx("path",{d:o,fill:"none",stroke:t.color,strokeWidth:"2",strokeLinejoin:"round",strokeLinecap:"round",opacity:"0.9"},t.key)})]})}),e.jsx("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:u.series.map(t=>{const r=t.values.length?t.values[t.values.length-1]:void 0;return e.jsxs("div",{className:"pill ok",style:{borderColor:t.color,color:t.color,background:"rgba(0,0,0,0.25)"},title:t.label,children:[e.jsx("span",{style:{fontFamily:"var(--font-data)",fontWeight:900},children:t.label}),e.jsx("span",{style:{fontFamily:"var(--font-data)",opacity:.85},children:L(r)})]},t.key)})})]})}function U(){const a=B(),l=Y(),[x,u]=i.useState([]),[b,p]=i.useState({}),[y,v]=i.useState("all"),[g,k]=i.useState(""),[S,j]=i.useState(!1),[t,r]=i.useState([]),o=i.useRef(new Map),[c,h]=i.useState(0),A=240,F=i.useCallback(async()=>{j(!0);try{const[s,n]=await Promise.all([$.getIndustries(),$.getSensors()]);u(s),p(n)}catch(s){a.show(s instanceof Error?s.message:"Failed to load sensors","bad")}finally{j(!1)}},[a]);i.useEffect(()=>{F().catch(()=>{})},[F]);const w=i.useMemo(()=>{const s=[];for(const[n,d]of Object.entries(b??{})){const f=Array.isArray(d?.sensors)?d.sensors:[];for(const m of f)s.push({industry:n,sensor:m})}return s},[b]),I=i.useMemo(()=>{const s=g.trim().toLowerCase();return w.filter(n=>y!=="all"&&n.industry!==y?!1:s?`${n.sensor.path} ${n.sensor.name} ${n.sensor.type??""} ${n.sensor.unit??""} ${n.sensor.plc_vendor??""} ${n.sensor.plc_model??""}`.toLowerCase().includes(s):!0)},[w,y,g]);i.useEffect(()=>{if(l.connected)return l.subscribe(t),()=>{}},[l.connected,t.join("|")]),i.useEffect(()=>{const s=l.sensorData;if(!s||typeof s!="object")return;let n=!1;for(const d of t){const f=s[d];if(typeof f!="number"||!Number.isFinite(f))continue;const m=o.current.get(d)??[];m.push(f),m.length>A&&m.splice(0,m.length-A),o.current.set(d,m),n=!0}n&&h(d=>d+1)},[t,l.sensorData]);const T=i.useMemo(()=>{const s=new Map;for(const n of w)s.set(n.sensor.path,{label:n.sensor.path,unit:n.sensor.unit});return s},[w]),W=i.useMemo(()=>t.map(s=>{const n=T.get(s);return{key:s,label:n?.unit?`${s} (${n.unit})`:s,values:o.current.get(s)??[]}}),[t,T,c]),R=s=>{r(n=>n.includes(s)?n:[...n,s].slice(0,8))},_=s=>{r(n=>n.filter(d=>d!==s)),o.current.delete(s),l.unsubscribe([s])};return e.jsxs("div",{style:{display:"grid",gap:16},children:[e.jsxs(C,{title:"Sensor overlay",subtitle:"Pick sensors and overlay live charts",children:[e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(M,{kind:l.connected?"ok":"warn",children:["WS: ",l.connected?"connected":"disconnected"]}),e.jsxs(M,{kind:t.length?"ok":"warn",children:["Selected: ",t.length,"/8"]}),e.jsx("div",{className:"muted",children:"Live values come from WebSocket subscriptions (same contract as legacy)."})]}),e.jsx("div",{style:{marginTop:12},children:e.jsx(V,{series:W,height:260,maxPoints:A})}),t.length>0?e.jsx("div",{style:{marginTop:12,display:"flex",gap:10,flexWrap:"wrap"},children:t.map(s=>e.jsxs(N,{variant:"danger",type:"button",onClick:()=>_(s),children:["Remove ",s]},s))}):e.jsx("div",{className:"muted",style:{marginTop:12},children:"Select sensors below to start streaming and plotting."})]}),e.jsxs(C,{title:"Sensors",subtitle:"Browse and add to overlay",actions:e.jsx(N,{type:"button",onClick:()=>F(),disabled:S,children:S?"Refreshing...":"Refresh"}),children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[e.jsx(P,{label:"Industry",children:e.jsxs(z,{value:y,onChange:s=>v(s.target.value),children:[e.jsx("option",{value:"all",children:"All industries"}),x.map(s=>e.jsxs("option",{value:s.name,children:[s.name," (",s.sensor_count,")"]},s.name))]})}),e.jsx(P,{label:"Search",children:e.jsx(O,{value:g,onChange:s=>k(s.target.value),placeholder:"Filter by name/path/type/unit/plc…"})})]}),e.jsxs("div",{className:"muted",style:{marginTop:10},children:["Showing ",I.length," sensors. Click “Add” to overlay (max 8)."]}),e.jsx("div",{style:{marginTop:10,border:"1px solid var(--border-panel)",borderRadius:2,overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontFamily:"var(--font-data)",fontSize:12},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"rgba(0,0,0,0.35)"},children:[e.jsx("th",{style:{textAlign:"left",padding:8,width:110},children:"Industry"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Path"}),e.jsx("th",{style:{textAlign:"left",padding:8,width:120},children:"Type"}),e.jsx("th",{style:{textAlign:"left",padding:8,width:90},children:"Unit"}),e.jsx("th",{style:{textAlign:"left",padding:8,width:180},children:"PLC"}),e.jsx("th",{style:{textAlign:"right",padding:8,width:120},children:"Action"})]})}),e.jsxs("tbody",{children:[I.slice(0,250).map(s=>{const n=s.sensor.path,d=[s.sensor.plc_vendor,s.sensor.plc_model].filter(Boolean).join(" "),f=t.includes(n);return e.jsxs("tr",{style:{borderTop:"1px solid rgba(255,255,255,0.03)"},children:[e.jsx("td",{style:{padding:8,color:"var(--text-secondary)"},children:s.industry}),e.jsx("td",{style:{padding:8,color:"var(--text-accent)"},children:n}),e.jsx("td",{style:{padding:8},children:s.sensor.type??"—"}),e.jsx("td",{style:{padding:8},children:s.sensor.unit??"—"}),e.jsx("td",{style:{padding:8,color:"var(--text-secondary)"},children:d||"—"}),e.jsx("td",{style:{padding:8,textAlign:"right"},children:e.jsx(N,{type:"button",variant:f?"secondary":"primary",disabled:f||t.length>=8,onClick:()=>R(n),children:f?"Added":"Add"})})]},n)}),I.length>250&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"muted",style:{padding:10},children:"Showing first 250 results. Narrow your filter to see more."})})]})]})})]})]})}export{U as SensorsPage};
