import{u as ne,r as a,j as s,P as A,F as m,a as re,T as b,B as c}from"./index-D7osG2pV.js";import{s as f}from"./simApi-GdAodEFA.js";function ie(){const r=ne(),[o,R]=a.useState("opcua"),[B,Z]=a.useState(null),[C,_]=a.useState(!1),[x,d]=a.useState(!1),[M,F]=a.useState(!1),[i,u]=a.useState({}),[k,O]=a.useState(null),[S,v]=a.useState(new Set),[j,N]=a.useState(new Set),[w,L]=a.useState(new Set),[q,y]=a.useState("");function T(e){const t=(e||"").split(".").map(l=>l.trim()).filter(Boolean);return t.length!==3?null:{catalog:t[0],schema:t[1],table:t[2]}}const z=a.useMemo(()=>{const e=i?.target??{},t=String(e?.catalog??""),l=String(e?.schema??""),n=String(e?.table??"");return[t,l,n].filter(Boolean).join(".")},[i]),D=a.useCallback(e=>{const t=T(e);t&&u(l=>({...l,target:{...l?.target??{},...t}}))},[]),g=a.useCallback(async()=>{try{Z(await f.zeroBusStatus())}catch(e){r.show(e instanceof Error?e.message:"Failed to load status","bad")}},[r]),W=a.useCallback(async()=>{F(!0);try{const e=await f.getSensors();O(e)}catch(e){r.show(e instanceof Error?e.message:"Failed to load sensors","bad")}finally{F(!1)}},[r]),E=a.useCallback(async()=>{_(!0);try{const e=await f.loadZeroBusConfig(o);if(e?.success){u(e.config??{});const t=Array.isArray(e?.config?.selected_sensors)?e.config.selected_sensors:[];v(new Set(t)),y("Loaded saved config"),r.show("Loaded saved config","ok")}else y(String(e?.message??"No saved config")),r.show(String(e?.message??"No saved config"),"warn")}catch(e){r.show(e instanceof Error?e.message:"Failed to load config","bad")}finally{_(!1)}},[o,r]);a.useEffect(()=>{g().catch(()=>{}),W().catch(()=>{}),E().catch(()=>{})},[o]),a.useEffect(()=>{u(e=>({...e,selected_sensors:Array.from(S)}))},[S]);const p=a.useMemo(()=>{if(!k)return[];const e=[];for(const t of Object.values(k)){const l=String(t.display_name??t.name??"Unknown");for(const n of t.sensors??[]){const se=String(n.plc_vendor??"").trim(),te=String(n.plc_model??"").trim(),ae=`${se} ${te}`.trim()||"Unknown PLC";e.push({path:String(n.path??""),name:String(n.name??""),type:String(n.type??"unknown"),industryDisplay:l,plc:ae})}}return e.filter(t=>t.path.length>0)},[k]),J=a.useMemo(()=>Array.from(new Set(p.map(e=>e.industryDisplay))).sort((e,t)=>e.localeCompare(t)),[p]),H=a.useMemo(()=>Array.from(new Set(p.map(e=>e.plc))).sort((e,t)=>e.localeCompare(t)),[p]),h=a.useMemo(()=>p.filter(e=>!(j.size>0&&!j.has(e.industryDisplay)||w.size>0&&!w.has(e.plc))),[p,j,w]),U=a.useCallback((e,t)=>{N(l=>{const n=new Set(l);return t?n.add(e):n.delete(e),n})},[]),$=a.useCallback((e,t)=>{L(l=>{const n=new Set(l);return t?n.add(e):n.delete(e),n})},[]),Q=a.useCallback((e,t)=>{v(l=>{const n=new Set(l);return t?n.add(e):n.delete(e),n})},[]),V=a.useCallback(()=>{v(e=>{const t=new Set(e);for(const l of h)t.add(l.path);return t})},[h]),G=a.useCallback(()=>{v(e=>{const t=new Set(e);for(const l of h)t.delete(l.path);return t})},[h]),K=a.useCallback(async()=>{d(!0);try{const e=await f.saveZeroBusConfig(o,i);y(JSON.stringify(e,null,2)),r.show(String(e?.message??"Saved"),e?.success===!1?"warn":"ok"),await g()}catch(e){r.show(e instanceof Error?e.message:"Save failed","bad")}finally{d(!1)}},[i,o,g,r]),X=a.useCallback(async()=>{d(!0);try{const e=await f.testZeroBus(o,i);y(JSON.stringify(e,null,2)),r.show(String(e?.message??"Test complete"),e?.success===!1?"warn":"ok")}catch(e){r.show(e instanceof Error?e.message:"Test failed","bad")}finally{d(!1)}},[i,o,r]),Y=a.useCallback(async()=>{d(!0);try{const e=await f.startZeroBus(o);y(JSON.stringify(e,null,2)),r.show(String(e?.message??"Start requested"),e?.success===!1?"warn":"ok"),await g()}catch(e){r.show(e instanceof Error?e.message:"Start failed","bad")}finally{d(!1)}},[o,g,r]),ee=a.useCallback(async()=>{d(!0);try{const e=await f.stopZeroBus(o);y(JSON.stringify(e,null,2)),r.show(String(e?.message??"Stop requested"),e?.success===!1?"warn":"ok"),await g()}catch(e){r.show(e instanceof Error?e.message:"Stop failed","bad")}finally{d(!1)}},[o,g,r]),P=!!B?.status?.[o]?.has_config,I=!!B?.status?.[o]?.active;return s.jsxs("div",{style:{display:"grid",gap:16},children:[s.jsx(A,{title:"ZeroBus",subtitle:"Per-protocol configuration + start/stop/test",actions:s.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[s.jsx(c,{type:"button",onClick:()=>g(),disabled:C||x,children:"Refresh status"}),s.jsx(c,{type:"button",onClick:()=>E(),disabled:C,children:C?"Loading...":"Load saved"}),s.jsx(c,{variant:"primary",type:"button",onClick:()=>K(),disabled:x,children:"Save"}),s.jsx(c,{type:"button",onClick:()=>X(),disabled:x,children:"Test"}),s.jsx(c,{variant:"primary",type:"button",onClick:()=>Y(),disabled:x||!P,children:"Start streaming"}),s.jsx(c,{variant:"danger",type:"button",onClick:()=>ee(),disabled:x||!I,children:"Stop streaming"})]}),children:s.jsxs("div",{style:{display:"grid",gap:10},children:[s.jsx(m,{label:"Protocol",children:s.jsxs(re,{value:o,onChange:e=>R(e.target.value),children:[s.jsx("option",{value:"opcua",children:"OPC-UA"}),s.jsx("option",{value:"mqtt",children:"MQTT"}),s.jsx("option",{value:"modbus",children:"Modbus"})]})}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[s.jsx(m,{label:"Workspace host",children:s.jsx(b,{value:String(i?.workspace_host??""),onChange:e=>u(t=>({...t,workspace_host:e.target.value})),placeholder:"https://adb-..."})}),s.jsx(m,{label:"ZeroBus endpoint",children:s.jsx(b,{value:String(i?.zerobus_endpoint??""),onChange:e=>u(t=>({...t,zerobus_endpoint:e.target.value})),placeholder:"<workspaceId>.zerobus.<region>.cloud.databricks.com"})})]}),s.jsx(m,{label:"Target table (catalog.schema.table)",children:s.jsx(b,{value:z,onChange:e=>{const t=e.target.value;u(n=>({...n,__table_fqn_draft:t})),T(t)&&D(t)},placeholder:"main.iot_data.sensor_readings"})}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[s.jsx(m,{label:"Client ID",children:s.jsx(b,{value:String(i?.auth?.client_id??""),onChange:e=>u(t=>({...t,auth:{...t?.auth??{},client_id:e.target.value}}))})}),s.jsx(m,{label:"Client secret",children:s.jsx(b,{type:"password",value:String(i?.auth?.client_secret??""),onChange:e=>u(t=>({...t,auth:{...t?.auth??{},client_secret:e.target.value}}))})})]}),s.jsxs("div",{style:{border:"1px solid var(--border-panel)",borderRadius:2,padding:12,display:"grid",gap:10},children:[s.jsx("div",{className:"section-title",children:"Sensor selection for ZeroBus"}),s.jsxs("div",{className:"muted",children:["Selected: ",s.jsx("strong",{children:S.size})," / ",p.length," sensors"]}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[s.jsxs("div",{style:{display:"grid",gap:6},children:[s.jsx("div",{className:"muted",style:{fontWeight:600},children:"Filter by Industry"}),s.jsx("div",{style:{maxHeight:140,overflow:"auto",border:"1px solid var(--border-panel)",borderRadius:2,padding:8},children:J.map(e=>s.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:6},children:[s.jsx("input",{type:"checkbox",checked:j.has(e),onChange:t=>U(e,t.target.checked)}),s.jsx("span",{children:e})]},e))})]}),s.jsxs("div",{style:{display:"grid",gap:6},children:[s.jsx("div",{className:"muted",style:{fontWeight:600},children:"Filter by PLC/System"}),s.jsx("div",{style:{maxHeight:140,overflow:"auto",border:"1px solid var(--border-panel)",borderRadius:2,padding:8},children:H.map(e=>s.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:6},children:[s.jsx("input",{type:"checkbox",checked:w.has(e),onChange:t=>$(e,t.target.checked)}),s.jsx("span",{children:e})]},e))})]})]}),s.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap"},children:[s.jsxs(c,{type:"button",onClick:()=>V(),children:["Select filtered (",h.length,")"]}),s.jsx(c,{type:"button",onClick:()=>G(),children:"Clear filtered"}),s.jsx(c,{type:"button",onClick:()=>{N(new Set),L(new Set)},children:"Clear filters"})]}),s.jsx("div",{style:{maxHeight:260,overflow:"auto",border:"1px solid var(--border-panel)",borderRadius:2,padding:8},children:M?s.jsx("div",{className:"muted",children:"Loading sensors..."}):h.length===0?s.jsx("div",{className:"muted",children:"No sensors match current filters."}):h.map(e=>s.jsxs("label",{style:{display:"grid",gridTemplateColumns:"20px 1fr",gap:8,marginBottom:8},children:[s.jsx("input",{type:"checkbox",checked:S.has(e.path),onChange:t=>Q(e.path,t.target.checked)}),s.jsxs("span",{children:[s.jsx("strong",{children:e.name}),s.jsxs("span",{className:"muted",children:[" - ",e.industryDisplay," - ",e.plc]})]})]},e.path))})]}),s.jsxs("div",{className:"muted",children:["Status: ",I?"streaming active":"inactive","; saved config: ",P?"yes":"no"]})]})}),s.jsx(A,{title:"Last result",subtitle:"Raw response",children:s.jsx("pre",{className:"kvs",style:{margin:0},children:s.jsx("code",{style:{color:"var(--text-primary)"},children:q||"â€”"})})})]})}export{ie as ZeroBusPage};
