import{r as i,j as e,u as D,B as U,P as W}from"./index-BaPJlJ0v.js";import{s as L}from"./simApi-GdAodEFA.js";function K(s){return!s||typeof s!="object"?[]:Object.entries(s)}function q(s){const c=i.useMemo(()=>K(s.data),[s.data]),u=s.maxRows??200,[m,p]=i.useState(!1);if(c.length===0)return e.jsx("div",{className:`muted ${s.className??""}`.trim(),children:s.emptyText??"No data"});const w=m?c:c.slice(0,u);return e.jsxs("div",{className:`kvs ${s.className??""}`.trim(),children:[w.map(([x,l])=>e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"k",children:x}),e.jsx("div",{className:"v",children:typeof l=="string"?l:JSON.stringify(l,null,2)})]},x)),c.length>u&&e.jsx("div",{style:{paddingTop:10},children:e.jsx("button",{className:"btn btn-secondary",type:"button",onClick:()=>p(x=>!x),children:m?`Show first ${u}`:`Show all (${c.length})`})})]})}const z={temperature:"temp",pressure:"press",vibration:"vib",position:"pos",current:"curr",voltage:"volt",frequency:"freq",humidity:"hum",conveyor:"conv"};function _(s){const c=s.toLowerCase();for(const[u,m]of Object.entries(z))if(c.includes(u))return[s,s.replace(new RegExp(u,"gi"),m)];return[s]}function B(s,c){return c.type==="sensor"&&c.path?`sensor:${c.path}`:s?`${s}/${c.name}`:c.name}function F(s,c,u){const m=B(c,s);u(s,m),s.children?.forEach(p=>F(p,m,u))}function V(s,c){const u=_(c).map(l=>l.toLowerCase()).filter(Boolean),m=new Set,p=l=>{const y=`${l.name??""} ${l.type??""} ${l.path??""}`.toLowerCase();return u.some(g=>y.includes(g))},w=(l,y)=>{const g=B(y,l),N=(l.children||[]).map(T=>w(T,g)).filter(T=>T!==null);return p(l)||N.length>0?(N.length>0&&m.add(g),{...l,children:N.length>0?N:l.children}):null},x=s.children.map(l=>w(l,s.name)).filter(l=>l!==null);return{filtered:{...s,children:x},expandKeys:m}}function G(s){const{data:c,refresh:u,refreshMs:m=500}=s,[p,w]=i.useState(""),[x,l]=i.useState(()=>new Set(["Objects"])),[y,g]=i.useState(!0),[N,$]=i.useState(()=>new Set),O=i.useRef(!1),T=i.useRef(new Map),h=i.useRef(new Map),b=i.useMemo(()=>c?{name:c.root||"Objects",type:"root",children:c.children||[]}:null,[c]),{viewRoot:C,searchExpand:E}=i.useMemo(()=>{if(!b)return{viewRoot:null,searchExpand:new Set};if(!p.trim())return{viewRoot:b,searchExpand:new Set};const a=V(b,p.trim());return{viewRoot:a.filtered,searchExpand:a.expandKeys}},[b,p]);i.useEffect(()=>{if(!y)return;const a=window.setInterval(async()=>{if(!O.current){O.current=!0;try{await u()}finally{O.current=!1}}},m);return()=>window.clearInterval(a)},[y,u,m]),i.useEffect(()=>{if(!b)return;const a=new Set;b.children.forEach(j=>{F(j,b.name,o=>{if(o.type!=="sensor"||!o.path||typeof o.value!="number")return;const t=T.current.get(o.path);t!==void 0&&t!==o.value&&a.add(o.path),T.current.set(o.path,o.value)})}),a.size!==0&&($(j=>{const o=new Set(j);return a.forEach(t=>o.add(t)),o}),a.forEach(j=>{const o=h.current.get(j);o&&window.clearTimeout(o);const t=window.setTimeout(()=>{$(n=>{const d=new Set(n);return d.delete(j),d}),h.current.delete(j)},500);h.current.set(j,t)}))},[b]);const f=a=>p.trim()&&E.has(a)||x.has(a),R=a=>{l(j=>{const o=new Set(j);return o.has(a)?o.delete(a):o.add(a),o})},S=(a,j)=>{const o=B(j,a),t=(a.children?.length||0)>0,n=!!(a.properties&&Object.keys(a.properties).length>0),d=t||n,r=d&&f(o),v=a.type==="root"||a.type==="folder"?"▸":a.type==="plc"?"⊙":a.type==="industry"?"◆":a.type==="sensor"?"●":"○",I=()=>{d&&R(o)},J=a.forced?"forced":(a.quality||"").toLowerCase().includes("uncertain")?"uncertain":(a.quality||"").toLowerCase().includes("bad")?"bad":"good";return e.jsxs("div",{className:"tree-node",children:[e.jsxs("div",{className:`tree-node-header${r?" active":""}`,onClick:I,"data-sensor-path":a.type==="sensor"?a.path:void 0,role:"button",tabIndex:0,children:[e.jsx("span",{className:`tree-chevron${r?" expanded":""}${d?"":" leaf"}`,children:"▶"}),e.jsx("span",{className:"tree-icon",children:v}),e.jsx("span",{className:"tree-label",children:a.name}),a.type==="sensor"?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:`tree-value${a.path&&N.has(a.path)?" updated":""}`,children:typeof a.value=="number"?a.value.toFixed(2):"--"}),e.jsx("span",{className:"tree-unit",children:a.unit||""}),e.jsx("span",{className:`tree-quality ${J}`,children:a.forced?"forced":a.quality||"good"})]}):null]}),d?e.jsxs("div",{className:`tree-children${r?" expanded":""}`,children:[n?e.jsx("div",{className:"tree-properties",children:Object.entries(a.properties||{}).map(([M,H])=>e.jsxs("div",{className:"tree-property",children:[e.jsxs("span",{className:"tree-property-name",children:[M,":"]}),e.jsx("span",{className:"tree-property-value",children:String(H)})]},`${o}:${M}`))}):null,t?a.children.map(M=>S(M,o)):null]}):null]},o)};return e.jsxs("div",{style:{display:"grid",gap:10},children:[e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"},children:[e.jsx("input",{className:"opcua-search-input",value:p,onChange:a=>w(a.target.value),placeholder:'Search nodes… (e.g. "crusher", "temperature", "freq")'}),e.jsxs("label",{className:"muted",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:y,onChange:a=>g(a.target.checked)}),"Auto-refresh"]})]}),e.jsx("div",{className:"opcua-tree-container",children:C?e.jsx("div",{children:S({name:C.name,type:"root",children:C.children},"")}):e.jsx("div",{className:"muted",children:"No hierarchy loaded yet."})})]})}function k(s){return s&&typeof s=="object"&&!Array.isArray(s)?s:{}}function A(s){return typeof s=="string"?s:""}function Q(s){return typeof s=="string"?s:Array.isArray(s)&&typeof s[0]=="string"?s[0]:""}function P(s){return typeof s=="number"&&Number.isFinite(s)}function X(s){return s.startsWith("saref:")?"saref":s.startsWith("sosa:")?"sosa":"other"}function Y(s){const c=D(),[u,m]=i.useState("properties"),[p,w]=i.useState(""),[x,l]=i.useState(""),[y,g]=i.useState(""),[N,$]=i.useState(""),[O,T]=i.useState(null),h=s.td??null,b=i.useMemo(()=>k(h&&h.properties),[h]),C=i.useMemo(()=>k(h&&h.actions),[h]),E=i.useMemo(()=>k(h&&h.events),[h]),f=i.useMemo(()=>{const t=[];for(const[n,d]of Object.entries(b)){if(!d||typeof d!="object"||Array.isArray(d))continue;const r=d,v=Array.isArray(r.forms)&&r.forms[0]&&typeof r.forms[0]=="object"?r.forms[0]:{};t.push({name:n,title:A(r.title)||n,description:A(r.description),semanticType:Q(r["@type"]),unit:A(r.unit),unitUri:A(r["qudt:unit"]),industry:A(r["ex:industry"]),minimum:P(r.minimum)?r.minimum:void 0,maximum:P(r.maximum)?r.maximum:void 0,nodeId:A(v["opcua:nodeId"]),browsePath:A(v["opcua:browsePath"])})}return t.sort((n,d)=>n.name.localeCompare(d.name)),t},[b]),R=i.useMemo(()=>{const t=Array.from(new Set(f.map(r=>r.semanticType).filter(Boolean))).sort((r,v)=>r.localeCompare(v)),n=Array.from(new Set(f.map(r=>r.industry).filter(Boolean))).sort((r,v)=>r.localeCompare(v)),d=Array.from(new Set(f.map(r=>r.unit).filter(Boolean))).sort((r,v)=>r.localeCompare(v));return{sem:t,ind:n,units:d}},[f]),S=i.useMemo(()=>{const t=new Set(f.map(r=>r.semanticType).filter(Boolean)),n=new Set(f.map(r=>r.industry).filter(Boolean)),d=new Set(f.map(r=>r.unit).filter(Boolean));return{total:f.length,semanticTypes:t.size,industries:n.size,units:d.size}},[f]),a=i.useMemo(()=>{const t=p.trim().toLowerCase();return f.filter(n=>{const d=!t||n.name.toLowerCase().includes(t)||n.title.toLowerCase().includes(t)||(n.description||"").toLowerCase().includes(t),r=!x||n.semanticType===x,v=!y||n.industry===y,I=!N||n.unit===N;return d&&r&&v&&I})},[f,p,x,y,N]),j=i.useMemo(()=>{if(!h)return null;const t=k(h),n={};return["title","id","@type","@context","base","description"].forEach(d=>{d in t&&(n[d]=t[d])}),n["properties.count"]=f.length,n["actions.count"]=Object.keys(C).length,n["events.count"]=Object.keys(E).length,n["semanticTypes.count"]=S.semanticTypes,n["industries.count"]=S.industries,n["units.count"]=S.units,"security"in t&&(n.security=t.security),"securityDefinitions"in t&&(n.securityDefinitions=t.securityDefinitions),n},[h,f.length,C,E,S]);async function o(){try{if(!h)return;await navigator.clipboard.writeText(JSON.stringify(h,null,2)),c.show("Copied Thing Description JSON","ok")}catch{c.show("Failed to copy to clipboard","bad")}}return e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:[[["summary","Summary"],["properties",`Properties (${f.length})`],["actions",`Actions (${Object.keys(C).length})`],["events",`Events (${Object.keys(E).length})`],["raw","Raw JSON"]].map(([t,n])=>e.jsx("button",{type:"button",className:`btn ${u===t?"btn-primary":"btn-secondary"}`,onClick:()=>{m(t),w(""),l(""),g(""),$(""),T(null)},children:n},t)),e.jsx("div",{style:{flex:1}}),e.jsx(U,{type:"button",variant:"secondary",onClick:o,disabled:!h,children:"Copy JSON"})]}),u==="summary"?e.jsx(q,{data:j,emptyText:"No thing description loaded yet."}):u==="raw"?e.jsx("pre",{className:"kvs",style:{margin:0},children:e.jsx("code",{style:{color:"var(--text-primary)"},children:JSON.stringify(h,null,2)})}):u!=="properties"?e.jsx(q,{data:u==="actions"?C:E,emptyText:`No ${u} in thing description.`,maxRows:200}):e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs("div",{className:"wot-stats-bar",children:[e.jsxs("div",{className:"wot-stat-card",children:[e.jsx("div",{className:"wot-stat-label",children:"Total Properties"}),e.jsx("div",{className:"wot-stat-value",children:S.total})]}),e.jsxs("div",{className:"wot-stat-card wot-lava",children:[e.jsx("div",{className:"wot-stat-label",children:"Semantic Types"}),e.jsx("div",{className:"wot-stat-value",children:S.semanticTypes})]}),e.jsxs("div",{className:"wot-stat-card wot-success",children:[e.jsx("div",{className:"wot-stat-label",children:"Industries"}),e.jsx("div",{className:"wot-stat-value",children:S.industries})]}),e.jsxs("div",{className:"wot-stat-card",children:[e.jsx("div",{className:"wot-stat-label",children:"W3C Compliant"}),e.jsx("div",{className:"wot-stat-value",children:"✓"})]})]}),e.jsxs("div",{className:"wot-controls",children:[e.jsx("div",{className:"wot-search-row",children:e.jsx("input",{className:"input",value:p,onChange:t=>w(t.target.value),placeholder:"Search properties by name…"})}),e.jsxs("div",{className:"wot-filter-row",children:[e.jsxs("select",{className:"input",value:x,onChange:t=>l(t.target.value),children:[e.jsx("option",{value:"",children:"All Semantic Types"}),R.sem.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{className:"input",value:y,onChange:t=>g(t.target.value),children:[e.jsx("option",{value:"",children:"All Industries"}),R.ind.map(t=>e.jsx("option",{value:t,children:t.replace(/_/g," ").toUpperCase()},t))]}),e.jsxs("select",{className:"input",value:N,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"",children:"All Units"}),R.units.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]}),e.jsxs("div",{className:"wot-results-info",children:["Showing ",e.jsx("strong",{children:a.length})," of ",e.jsx("strong",{children:f.length})," properties"]}),a.length===0?e.jsx("div",{className:"muted",style:{padding:18},children:"No results. Try clearing filters."}):e.jsx("div",{className:"wot-properties-grid",children:a.map(t=>{const n=X(t.semanticType),d=O===t.name;return e.jsxs("div",{className:`wot-property-card ${d?"expanded":""}`,role:"button",tabIndex:0,onClick:()=>T(r=>r===t.name?null:t.name),children:[e.jsxs("div",{className:"wot-property-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"wot-property-name",children:t.name}),e.jsx("div",{className:"wot-property-title muted",children:t.title})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[t.semanticType?e.jsx("span",{className:`wot-badge ${n}`,children:t.semanticType}):e.jsx("span",{className:"wot-badge other",children:"—"}),t.industry?e.jsx("span",{className:"wot-badge industry",children:t.industry.replace(/_/g," ")}):null,e.jsx("span",{className:"wot-badge opcua",children:"opcua"})]})]}),e.jsxs("div",{className:"wot-property-details",children:[e.jsxs("div",{className:"wot-detail",children:[e.jsx("div",{className:"wot-detail-label",children:"Unit"}),e.jsxs("div",{className:"wot-detail-value",children:[t.unit||"—"," ",t.unitUri?e.jsx("a",{className:"wot-unit-uri",href:t.unitUri,target:"_blank",rel:"noreferrer",children:"(uri)"}):null]})]}),e.jsxs("div",{className:"wot-detail",children:[e.jsx("div",{className:"wot-detail-label",children:"Range"}),e.jsx("div",{className:"wot-detail-value",children:P(t.minimum)||P(t.maximum)?`${t.minimum??"—"} → ${t.maximum??"—"}`:"—"})]}),e.jsxs("div",{className:"wot-detail",children:[e.jsx("div",{className:"wot-detail-label",children:"NodeId"}),e.jsx("div",{className:"wot-detail-value",children:t.nodeId||"—"})]})]}),d?e.jsxs("div",{className:"wot-property-more",children:[t.browsePath?e.jsxs("div",{className:"wot-more-row",children:[e.jsx("div",{className:"wot-detail-label",children:"BrowsePath"}),e.jsx("div",{className:"wot-detail-value",children:t.browsePath})]}):null,t.description?e.jsxs("div",{className:"wot-more-row",children:[e.jsx("div",{className:"wot-detail-label",children:"Description"}),e.jsx("div",{className:"wot-detail-value",children:t.description})]}):null]}):e.jsx("div",{className:"wot-hint muted",children:"Click to expand"})]},t.name)})})]}),e.jsxs("div",{className:"muted",children:["Tip: for the legacy full-page WoT browser, open ",e.jsx("code",{children:"/wot/browser"}),"."]})]})}function te(){const s=D(),[c,u]=i.useState(null),[m,p]=i.useState(null),[w,x]=i.useState(!1),l=i.useCallback(async()=>{x(!0);try{const[y,g]=await Promise.all([L.getOpcuaHierarchy(),L.getThingDescription()]);u(y),p(g)}catch(y){s.show(y instanceof Error?y.message:"Failed to load OPC-UA/WoT data","bad")}finally{x(!1)}},[s]);return i.useEffect(()=>{l().catch(()=>{})},[l]),e.jsxs("div",{style:{display:"grid",gap:16},children:[e.jsx(W,{title:"OPC-UA / WoT",subtitle:"Hierarchy browser + Thing Description",actions:e.jsxs("div",{style:{display:"flex",gap:10},children:[e.jsx(U,{type:"button",onClick:()=>l(),disabled:w,children:w?"Refreshing...":"Refresh"}),e.jsx("a",{href:"/wot/browser",style:{textDecoration:"none"},children:e.jsx(U,{type:"button",children:"Open WoT browser"})})]}),children:e.jsxs("div",{className:"muted",children:["Uses ",e.jsx("code",{children:"/api/opcua/hierarchy"})," and ",e.jsx("code",{children:"/api/opcua/thing-description"}),"."]})}),e.jsx(W,{title:"OPC-UA hierarchy",subtitle:"Browsable node tree (live values)",children:e.jsx(G,{data:c,refresh:l,refreshMs:500})}),e.jsx(W,{title:"Thing Description",subtitle:"WoT browser (properties/actions/events)",children:e.jsx(Y,{td:m})})]})}export{te as OpcuaWotPage};
