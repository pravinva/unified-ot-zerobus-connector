# Rsyslog Configuration for SIEM Integration
# NIS2 Compliance: Article 21.2(b) - Incident Handling
#
# This configuration sends logs to a remote syslog server (SIEM).
# Supports: Splunk, QRadar, ArcSight, Azure Sentinel, etc.

# =============================================================================
# Modules
# =============================================================================

# Load input modules
module(load="imfile" PollingInterval="10")  # File monitoring
module(load="imuxsock")  # Local socket support
module(load="imklog")    # Kernel logging

# =============================================================================
# Global Directives
# =============================================================================

# Use default timestamp format (RFC3339)
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# Max message size (for large JSON events)
$MaxMessageSize 64k

# Queue settings for reliability
$ActionQueueType LinkedList
$ActionQueueFileName unified_connector_queue
$ActionQueueSaveOnShutdown on
$ActionQueueMaxDiskSpace 100m
$ActionResumeRetryCount -1

# =============================================================================
# Templates for JSON Formatting
# =============================================================================

# Template for JSON logs to SIEM
template(name="JSONFormat" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")      property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"hostname\":\"")    property(name="hostname")
    constant(value="\",\"application\":\"") property(name="programname")
    constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
    constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
    constant(value="\",\"message\":")       property(name="msg" format="json")
    constant(value="}")
}

# Template for CEF (Common Event Format) - for ArcSight, QRadar
template(name="CEFFormat" type="list") {
    constant(value="CEF:0|Unified OT Connector|")
    property(name="programname")
    constant(value="|1.0|")
    property(name="syslogseverity-text")
    constant(value="|")
    property(name="msg")
    constant(value="|severity=")
    property(name="syslogseverity")
    constant(value=" ")
}

# =============================================================================
# Input - Monitor Unified Connector Logs
# =============================================================================

# Application logs
input(type="imfile"
      File="/var/log/unified-connector/unified_connector.log"
      Tag="unified-connector"
      Severity="info"
      Facility="local0"
      reopenOnTruncate="on"
      addMetadata="on")

# Security logs (high priority)
input(type="imfile"
      File="/var/log/unified-connector/security.log"
      Tag="unified-connector-security"
      Severity="warning"
      Facility="local1"
      reopenOnTruncate="on"
      addMetadata="on")

# =============================================================================
# Filtering and Enrichment
# =============================================================================

# Add custom property for all unified-connector logs
$template AddAppName,"application=\"unified-ot-connector\""

# Filter security events
if $programname == 'unified-connector-security' then {
    set $.priority = "high";
    set $.log_type = "security";
}

# Filter authentication events
if $msg contains 'auth' then {
    set $.event_type = "authentication";
    set $.priority = "high";
}

# Filter injection attempts (CRITICAL)
if $msg contains 'injection' or $msg contains 'path_traversal' then {
    set $.priority = "critical";
    set $.alert = "true";
}

# =============================================================================
# Output - Send to Remote SIEM
# =============================================================================

# Option 1: Send to Splunk (TCP with TLS)
# action(type="omfwd"
#        Target="splunk.example.com"
#        Port="6514"
#        Protocol="tcp"
#        StreamDriver="gtls"
#        StreamDriverMode="1"
#        StreamDriverAuthMode="x509/name"
#        StreamDriverPermittedPeers="*.example.com"
#        template="JSONFormat"
#        queue.type="LinkedList"
#        queue.filename="splunk_queue"
#        queue.maxdiskspace="100m"
#        queue.saveonshutdown="on"
#        action.resumeRetryCount="-1")

# Option 2: Send to Azure Sentinel (via Syslog agent)
action(type="omfwd"
       Target="azure-sentinel-agent.example.com"
       Port="514"
       Protocol="tcp"
       template="JSONFormat")

# Option 3: Send to QRadar (CEF format)
# action(type="omfwd"
#        Target="qradar.example.com"
#        Port="514"
#        Protocol="tcp"
#        template="CEFFormat")

# Option 4: Send to generic syslog server
# action(type="omfwd"
#        Target="siem.example.com"
#        Port="514"
#        Protocol="tcp"
#        template="JSONFormat")

# =============================================================================
# Local Backup (for redundancy)
# =============================================================================

# Keep local copies for 30 days
$template DailyLogFile,"/var/log/unified-connector/archive/%$YEAR%-%$MONTH%-%$DAY%.log"

if $programname == 'unified-connector' or $programname == 'unified-connector-security' then {
    action(type="omfile" dynaFile="DailyLogFile")
}

# =============================================================================
# Rate Limiting (prevent log flooding attacks)
# =============================================================================

# Limit to 1000 messages per second
$SystemLogRateLimitInterval 1
$SystemLogRateLimitBurst 1000

# =============================================================================
# Performance Tuning
# =============================================================================

# Main queue size
$MainMsgQueueSize 50000

# Worker threads
$MainMsgQueueWorkerThreads 4

# Timeout for network operations
$ActionResumeInterval 10

# =============================================================================
# Debugging (uncomment for troubleshooting)
# =============================================================================

# $DebugFile /var/log/rsyslog-debug.log
# $DebugLevel 2
