# Security Alert Rules for SIEM Integration
# NIS2 Compliance: Article 21.2(b) - Incident Handling

# =============================================================================
# Critical Severity Alerts (Immediate Response Required)
# =============================================================================

critical_alerts:
  # Injection attack detected
  - name: "Injection Attack Detected"
    severity: CRITICAL
    description: "Command injection, SQL injection, or XSS attempt detected"
    condition:
      event_category: "security.injection_attempt"
    actions:
      - send_email: security-team@example.com
      - send_slack: "#security-alerts"
      - create_incident: true
      - escalate_after: 5m
    throttle: 1m

  # Multiple injection attempts from same source
  - name: "Multiple Injection Attempts"
    severity: CRITICAL
    description: "5+ injection attempts from same IP in 10 minutes"
    condition:
      event_category: "security.injection_attempt"
      timeframe: 10m
      threshold: 5
      group_by: source_ip
    actions:
      - block_ip: true
      - send_email: security-team@example.com
      - create_incident: true

  # Privilege escalation attempt
  - name: "Privilege Escalation Attempt"
    severity: CRITICAL
    description: "User attempting to access admin-only resources"
    condition:
      event_category: "authz.privilege_escalation"
    actions:
      - send_email: security-team@example.com
      - send_slack: "#security-alerts"
      - create_incident: true

  # System compromise indicators
  - name: "System Compromise Indicators"
    severity: CRITICAL
    description: "Multiple security events indicating potential compromise"
    condition:
      any_of:
        - event_category: "security.*"
          count: 10
          timeframe: 5m
        - event_category: "authz.denied"
          count: 20
          timeframe: 5m
      group_by: source_ip
    actions:
      - block_ip: true
      - send_email: security-team@example.com, soc@example.com
      - create_incident: true
      - escalate_immediately: true

# =============================================================================
# High Severity Alerts (Response Required Within 1 Hour)
# =============================================================================

high_alerts:
  # Brute force authentication attack
  - name: "Brute Force Attack"
    severity: HIGH
    description: "5+ failed authentication attempts in 5 minutes"
    condition:
      event_category: "auth.failure"
      timeframe: 5m
      threshold: 5
      group_by: [user, source_ip]
    actions:
      - send_email: security-team@example.com
      - send_slack: "#security-alerts"
      - temp_block_ip: 1h
    throttle: 5m

  # Unauthorized source deletion
  - name: "Unauthorized Source Deletion"
    severity: HIGH
    description: "Source deleted by non-admin user"
    condition:
      event_category: "source.deleted"
      user_role: ["operator", "viewer"]
    actions:
      - send_email: admin-team@example.com
      - create_incident: true

  # Multiple authorization failures
  - name: "Multiple Authorization Failures"
    severity: HIGH
    description: "User repeatedly denied access (potential insider threat)"
    condition:
      event_category: "authz.denied"
      timeframe: 10m
      threshold: 10
      group_by: user
    actions:
      - send_email: security-team@example.com
      - send_slack: "#security-alerts"
      - investigate_user: true

  # Authentication without MFA
  - name: "Authentication Without MFA"
    severity: HIGH
    description: "User authenticated without multi-factor authentication"
    condition:
      event_category: "auth.success"
      mfa: false
    actions:
      - send_email: security-team@example.com
      - log_audit: true
    enabled: true  # Set to false if MFA is optional

  # After-hours admin activity
  - name: "After-Hours Admin Activity"
    severity: HIGH
    description: "Admin activity outside business hours (8am-6pm)"
    condition:
      user_role: "admin"
      action: ["config.changed", "source.deleted"]
      time_of_day: ["00:00-08:00", "18:00-23:59"]
    actions:
      - send_email: admin-team@example.com
      - log_audit: true

# =============================================================================
# Medium Severity Alerts (Response Required Within 4 Hours)
# =============================================================================

medium_alerts:
  # Failed authentication spike
  - name: "Failed Authentication Spike"
    severity: MEDIUM
    description: "Unusual increase in failed authentications"
    condition:
      event_category: "auth.failure"
      timeframe: 1h
      threshold: 20
    actions:
      - send_email: security-team@example.com
      - log_audit: true
    throttle: 1h

  # Configuration change
  - name: "Configuration Change"
    severity: MEDIUM
    description: "System configuration was modified"
    condition:
      event_category: "config.changed"
    actions:
      - send_email: admin-team@example.com
      - log_audit: true

  # New source added
  - name: "New Source Added"
    severity: MEDIUM
    description: "New data source was added to system"
    condition:
      event_category: "source.added"
    actions:
      - send_email: admin-team@example.com
      - log_audit: true

  # Input validation failures
  - name: "Input Validation Failures"
    severity: MEDIUM
    description: "Multiple input validation failures (potential probing)"
    condition:
      event_category: "validation.failed"
      timeframe: 10m
      threshold: 5
      group_by: source_ip
    actions:
      - send_email: security-team@example.com
      - log_audit: true
    throttle: 10m

  # Geographic anomaly
  - name: "Geographic Anomaly"
    severity: MEDIUM
    description: "User authenticated from unusual location"
    condition:
      event_category: "auth.success"
      unusual_location: true
    actions:
      - send_email: security-team@example.com
      - log_audit: true
      - verify_user: true

# =============================================================================
# Low Severity Alerts (Informational, Review Daily)
# =============================================================================

low_alerts:
  # System error rate
  - name: "High Error Rate"
    severity: LOW
    description: "Error rate above normal threshold"
    condition:
      level: "ERROR"
      timeframe: 1h
      threshold: 50
    actions:
      - send_email: dev-team@example.com
    throttle: 1h

  # Session expired
  - name: "Session Expired"
    severity: LOW
    description: "User session expired (informational)"
    condition:
      event_category: "auth.session_expired"
    actions:
      - log_audit: true
    enabled: false  # Usually too noisy

  # System restart
  - name: "System Restart"
    severity: LOW
    description: "System was restarted"
    condition:
      event_category: "system.start"
    actions:
      - send_email: admin-team@example.com
      - log_audit: true

# =============================================================================
# Compliance Alerts (NIS2 Required)
# =============================================================================

compliance_alerts:
  # No MFA for 24 hours
  - name: "MFA Not Used"
    severity: HIGH
    description: "MFA has not been used for 24 hours (NIS2 violation)"
    condition:
      event_category: "auth.success"
      mfa: true
      timeframe: 24h
      threshold: 0  # Alert if count is 0
    actions:
      - send_email: compliance-team@example.com, security-team@example.com
      - create_compliance_incident: true

  # Failed security scan
  - name: "Security Scan Failed"
    severity: HIGH
    description: "Automated security scan failed or found vulnerabilities"
    condition:
      event_category: "security.vulnerability.detected"
    actions:
      - send_email: security-team@example.com, dev-team@example.com
      - create_incident: true

  # No security audit for 7 days
  - name: "Missing Security Audit"
    severity: MEDIUM
    description: "No security audit performed in 7 days (NIS2 requirement)"
    condition:
      event_category: "security.audit.complete"
      timeframe: 7d
      threshold: 0  # Alert if count is 0
    actions:
      - send_email: compliance-team@example.com
      - create_compliance_incident: true

# =============================================================================
# Alert Configuration
# =============================================================================

alert_settings:
  # General settings
  check_interval: 60s  # How often to evaluate rules
  max_alerts_per_minute: 10  # Rate limit to prevent alert storms

  # Email settings
  email:
    smtp_server: smtp.example.com
    smtp_port: 587
    smtp_user: alerts@example.com
    smtp_password: ${SMTP_PASSWORD}
    from_address: unified-connector-alerts@example.com

  # Slack settings
  slack:
    webhook_url: ${SLACK_WEBHOOK_URL}
    default_channel: "#security-alerts"

  # Incident management
  incident_management:
    system: servicenow  # servicenow, jira, pagerduty
    api_endpoint: https://example.service-now.com/api
    api_token: ${SERVICENOW_TOKEN}
    default_assignment_group: Security Operations

  # IP blocking
  ip_blocking:
    enabled: true
    firewall_api: ${FIREWALL_API_ENDPOINT}
    firewall_token: ${FIREWALL_TOKEN}
    max_block_duration: 24h

# =============================================================================
# Notification Templates
# =============================================================================

templates:
  email_critical:
    subject: "[CRITICAL] {alert_name} - Unified OT Connector"
    body: |
      Alert: {alert_name}
      Severity: CRITICAL
      Time: {timestamp}

      Description: {description}

      Details:
      - User: {user}
      - Source IP: {source_ip}
      - Event Category: {event_category}
      - Correlation ID: {correlation_id}

      Action Required: Immediate investigation and response required.

      View in SIEM: {siem_link}
      Incident Ticket: {incident_link}

  slack_critical:
    text: |
      :rotating_light: *CRITICAL ALERT* :rotating_light:
      *{alert_name}*

      {description}

      • User: `{user}`
      • Source IP: `{source_ip}`
      • Time: {timestamp}
      • Correlation ID: `{correlation_id}`

      <{siem_link}|View in SIEM> | <{incident_link}|View Incident>
