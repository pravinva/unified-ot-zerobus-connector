# Filebeat Configuration for ELK Stack (Elasticsearch, Logstash, Kibana)
# NIS2 Compliance: Article 21.2(b) - Incident Handling

# =============================================================================
# Filebeat Inputs - Where to read logs from
# =============================================================================

filebeat.inputs:
  # JSON logs from Unified OT Connector
  - type: log
    enabled: true
    paths:
      - /var/log/unified-connector/unified_connector.log
      - /var/log/unified-connector/security.log

    # Parse JSON logs
    json.keys_under_root: true
    json.add_error_key: true
    json.message_key: message

    # Fields to add to every event
    fields:
      application: unified-ot-connector
      environment: production
      log_type: application
    fields_under_root: true

    # Multiline handling (if needed)
    multiline.pattern: '^{|^\['
    multiline.negate: true
    multiline.match: after

    # Exclude certain patterns
    exclude_lines: ['^DEBUG', '^TRACE']

  # Security-specific logs
  - type: log
    enabled: true
    paths:
      - /var/log/unified-connector/security.log

    json.keys_under_root: true
    json.add_error_key: true

    fields:
      application: unified-ot-connector
      environment: production
      log_type: security
      priority: high
    fields_under_root: true

# =============================================================================
# Filebeat Modules - Pre-built log parsing
# =============================================================================

filebeat.modules:
  - module: system
    syslog:
      enabled: true
    auth:
      enabled: true

# =============================================================================
# Processors - Transform data before sending
# =============================================================================

processors:
  # Add host information
  - add_host_metadata:
      when.not.contains.tags: forwarded

  # Add Docker metadata if running in container
  - add_docker_metadata: ~

  # Add Kubernetes metadata if running in K8s
  - add_kubernetes_metadata: ~

  # Drop debug logs
  - drop_event:
      when:
        equals:
          level: DEBUG

  # Rename fields for consistency
  - rename:
      fields:
        - from: "event_category"
          to: "event.category"
        - from: "correlation_id"
          to: "trace.id"
      ignore_missing: true

  # Add event dataset
  - add_fields:
      target: event
      fields:
        dataset: unified-ot-connector
        module: security

# =============================================================================
# Output - Where to send logs
# =============================================================================

# Elasticsearch output
output.elasticsearch:
  enabled: true
  hosts: ["localhost:9200"]

  # Index naming
  index: "unified-connector-%{[agent.version]}-%{+yyyy.MM.dd}"

  # Authentication
  username: "elastic"
  password: "${ELASTICSEARCH_PASSWORD}"

  # SSL/TLS
  ssl.enabled: true
  ssl.certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
  ssl.certificate: "/etc/filebeat/certs/filebeat.crt"
  ssl.key: "/etc/filebeat/certs/filebeat.key"

  # Bulk settings
  bulk_max_size: 50

  # Retry settings
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s

# Alternative: Logstash output
# output.logstash:
#   enabled: false
#   hosts: ["localhost:5044"]
#   ssl.enabled: true
#   ssl.certificate_authorities: ["/etc/filebeat/certs/ca.crt"]

# =============================================================================
# Logging - Filebeat's own logs
# =============================================================================

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# =============================================================================
# Setup - Index lifecycle and dashboards
# =============================================================================

setup.ilm.enabled: true
setup.ilm.rollover_alias: "unified-connector"
setup.ilm.pattern: "{now/d}-000001"
setup.ilm.policy_name: "unified-connector-policy"

setup.template.enabled: true
setup.template.name: "unified-connector"
setup.template.pattern: "unified-connector-*"

setup.dashboards.enabled: true
setup.dashboards.directory: /etc/filebeat/dashboards

setup.kibana:
  host: "localhost:5601"
  username: "elastic"
  password: "${KIBANA_PASSWORD}"
  ssl.enabled: true
  ssl.certificate_authorities: ["/etc/filebeat/certs/ca.crt"]

# =============================================================================
# Monitoring
# =============================================================================

monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["localhost:9200"]
  username: "elastic"
  password: "${ELASTICSEARCH_PASSWORD}"

# =============================================================================
# HTTP Endpoint (for health checks)
# =============================================================================

http.enabled: true
http.host: "0.0.0.0"
http.port: 5066
