# Incident Response Playbooks and Runbooks
# NIS2 Compliance: Article 21.2(b) - Incident Handling
#
# Playbooks define step-by-step procedures for responding to specific
# types of security incidents.

# =============================================================================
# Injection Attack Playbook
# =============================================================================

injection_attack:
  name: "Injection Attack Response"
  severity: CRITICAL
  response_time_sla: "15 minutes"

  description: |
    Response procedures for command injection, SQL injection, or XSS attacks.
    These attacks can lead to system compromise and data breaches.

  detection_indicators:
    - event_category: "security.injection_attempt"
    - Suspicious characters in user input: ; | & < > $ ` ' "
    - SQL keywords in unexpected fields
    - JavaScript code in form submissions

  immediate_actions:
    - step: 1
      action: "Acknowledge incident"
      owner: "Security Team"
      timeout: "5 minutes"
      commands:
        - "Log into incident management system"
        - "Assign incident to security analyst"

    - step: 2
      action: "Block attacker IP address"
      owner: "Security Team"
      timeout: "5 minutes"
      automated: true
      commands:
        - "python scripts/block_ip.py --ip {{ source_ip }} --duration 24h"
        - "Verify IP block in firewall logs"

    - step: 3
      action: "Isolate affected system"
      owner: "Operations Team"
      timeout: "10 minutes"
      commands:
        - "Disable network access for affected component"
        - "Preserve system state for forensics"

    - step: 4
      action: "Assess impact"
      owner: "Security Team"
      timeout: "15 minutes"
      commands:
        - "python scripts/analyze_logs.py --report security --source-ip {{ source_ip }}"
        - "Check for successful exploitation"
        - "Identify affected data/systems"

  investigation:
    - step: 5
      action: "Collect evidence"
      owner: "Security Team"
      commands:
        - "python scripts/collect_incident_evidence.py --incident {{ incident_id }}"
        - "Capture relevant log files"
        - "Take system snapshots"
        - "Document attack timeline"

    - step: 6
      action: "Analyze attack vector"
      owner: "Security Team"
      commands:
        - "Review application logs"
        - "Identify vulnerable endpoint"
        - "Assess input validation failures"
        - "Check for similar vulnerabilities"

    - step: 7
      action: "Determine if data was compromised"
      owner: "Security Team"
      commands:
        - "Review database query logs"
        - "Check for unauthorized data access"
        - "Identify potentially exfiltrated data"

  containment:
    - step: 8
      action: "Apply emergency patch"
      owner: "Development Team"
      commands:
        - "Deploy input validation fix"
        - "Enable WAF rules"
        - "Update security configurations"

    - step: 9
      action: "Verify containment"
      owner: "Security Team"
      commands:
        - "Test patch effectiveness"
        - "Verify attacker is blocked"
        - "Monitor for continued attempts"

  eradication:
    - step: 10
      action: "Remove any backdoors or malware"
      owner: "Security Team"
      commands:
        - "Scan systems for malware"
        - "Check for unauthorized accounts"
        - "Review system configurations"

    - step: 11
      action: "Patch vulnerability permanently"
      owner: "Development Team"
      commands:
        - "Implement proper input sanitization"
        - "Add parameterized queries"
        - "Enable Content Security Policy (CSP)"
        - "Deploy to production"

  recovery:
    - step: 12
      action: "Restore normal operations"
      owner: "Operations Team"
      commands:
        - "Re-enable affected systems"
        - "Monitor system health"
        - "Verify functionality"

    - step: 13
      action: "Enhanced monitoring"
      owner: "Security Team"
      duration: "7 days"
      commands:
        - "Enable verbose logging"
        - "Monitor for similar attacks"
        - "Review WAF logs daily"

  post_incident:
    - step: 14
      action: "Document lessons learned"
      owner: "Security Team"
      commands:
        - "Complete incident report"
        - "Identify process improvements"
        - "Update security procedures"

    - step: 15
      action: "Regulatory notification (if required)"
      owner: "Compliance Team"
      timeline: "72 hours"
      commands:
        - "Determine if breach notification required (GDPR, NIS2)"
        - "Notify authorities if required"
        - "Prepare customer notifications"

  escalation:
    triggers:
      - condition: "No acknowledgment within 5 minutes"
        action: "Escalate to Security Manager"
      - condition: "Data breach confirmed"
        action: "Escalate to CISO and Legal"
      - condition: "Customer data compromised"
        action: "Activate data breach response plan"

# =============================================================================
# Brute Force Attack Playbook
# =============================================================================

brute_force_attack:
  name: "Brute Force Attack Response"
  severity: HIGH
  response_time_sla: "1 hour"

  description: |
    Response procedures for brute force authentication attacks.
    Multiple failed login attempts indicating password guessing.

  detection_indicators:
    - event_category: "auth.failure"
    - 5+ failed attempts within 5 minutes
    - Same source IP or same username

  immediate_actions:
    - step: 1
      action: "Temporarily block source IP"
      automated: true
      commands:
        - "python scripts/block_ip.py --ip {{ source_ip }} --duration 1h"

    - step: 2
      action: "Lock affected user account"
      owner: "Security Team"
      commands:
        - "python scripts/lock_account.py --user {{ username }}"
        - "Notify user via alternate channel"

    - step: 3
      action: "Assess scope"
      owner: "Security Team"
      commands:
        - "python scripts/analyze_logs.py --report security --user {{ username }}"
        - "Check for other targeted accounts"
        - "Identify attack patterns"

  investigation:
    - step: 4
      action: "Determine if any accounts compromised"
      owner: "Security Team"
      commands:
        - "Check for successful logins from attacker IP"
        - "Review session logs"
        - "Check for privilege escalations"

    - step: 5
      action: "Analyze attack source"
      owner: "Security Team"
      commands:
        - "IP geolocation lookup"
        - "Check against known botnets"
        - "Correlate with other security events"

  containment:
    - step: 6
      action: "Enforce rate limiting"
      owner: "Development Team"
      commands:
        - "Enable login rate limiting"
        - "Implement CAPTCHA"
        - "Add account lockout policy"

    - step: 7
      action: "Force password resets"
      owner: "Security Team"
      conditional: "If accounts compromised"
      commands:
        - "Force password reset for affected users"
        - "Revoke all active sessions"
        - "Enable MFA enforcement"

  recovery:
    - step: 8
      action: "Unlock accounts and unblock IPs"
      owner: "Security Team"
      commands:
        - "Verify attack has stopped"
        - "Unlock user accounts after password reset"
        - "Remove IP blocks if safe"

  post_incident:
    - step: 9
      action: "Strengthen authentication"
      owner: "Security Team"
      commands:
        - "Enforce strong password policy"
        - "Mandate MFA for all users"
        - "Implement anomaly detection"

  escalation:
    triggers:
      - condition: "Account compromised"
        action: "Escalate to Security Manager"
      - condition: "Admin account targeted"
        action: "Immediate escalation to CISO"

# =============================================================================
# Privilege Escalation Playbook
# =============================================================================

privilege_escalation:
  name: "Privilege Escalation Response"
  severity: CRITICAL
  response_time_sla: "15 minutes"

  description: |
    Response procedures for privilege escalation attempts.
    User attempting to access admin-only resources or elevate privileges.

  detection_indicators:
    - event_category: "authz.privilege_escalation"
    - Non-admin accessing admin endpoints
    - Role manipulation attempts

  immediate_actions:
    - step: 1
      action: "Terminate user sessions immediately"
      automated: true
      commands:
        - "python scripts/revoke_sessions.py --user {{ username }}"

    - step: 2
      action: "Lock user account"
      automated: true
      commands:
        - "python scripts/lock_account.py --user {{ username }}"

    - step: 3
      action: "Alert security team"
      automated: true
      commands:
        - "Send high-priority alert"
        - "Notify CISO if admin account"

  investigation:
    - step: 4
      action: "Determine escalation method"
      owner: "Security Team"
      commands:
        - "Review user activity logs"
        - "Check for exploited vulnerabilities"
        - "Identify attack vector"

    - step: 5
      action: "Assess damage"
      owner: "Security Team"
      commands:
        - "Check if escalation was successful"
        - "Review actions taken with elevated privileges"
        - "Identify affected systems/data"

  containment:
    - step: 6
      action: "Patch vulnerability"
      owner: "Development Team"
      urgent: true
      commands:
        - "Identify and fix authorization flaw"
        - "Deploy emergency patch"
        - "Review similar code paths"

    - step: 7
      action: "Audit all user roles"
      owner: "Security Team"
      commands:
        - "Review role assignments"
        - "Remove excessive permissions"
        - "Implement least privilege"

  eradication:
    - step: 8
      action: "Fix root cause"
      owner: "Development Team"
      commands:
        - "Implement proper RBAC checks"
        - "Add authorization unit tests"
        - "Security code review"

  recovery:
    - step: 9
      action: "Restore compromised accounts"
      owner: "Security Team"
      commands:
        - "Reset passwords"
        - "Re-assign correct roles"
        - "Enable enhanced logging"

  post_incident:
    - step: 10
      action: "Security architecture review"
      owner: "Security Team"
      commands:
        - "Review authorization model"
        - "Implement principle of least privilege"
        - "Add privilege escalation monitoring"

  escalation:
    triggers:
      - condition: "Successful privilege escalation"
        action: "Immediate escalation to CISO"
      - condition: "Data accessed with elevated privileges"
        action: "Activate data breach response"

# =============================================================================
# Configuration Change Incident Playbook
# =============================================================================

unauthorized_config_change:
  name: "Unauthorized Configuration Change"
  severity: MEDIUM
  response_time_sla: "4 hours"

  description: |
    Response procedures for unauthorized or suspicious configuration changes.

  detection_indicators:
    - event_category: "config.changed"
    - Non-admin user making changes
    - After-hours changes
    - Suspicious configuration values

  immediate_actions:
    - step: 1
      action: "Document change details"
      automated: true
      commands:
        - "python scripts/capture_config_diff.py --incident {{ incident_id }}"

    - step: 2
      action: "Verify change authorization"
      owner: "Operations Team"
      commands:
        - "Check change management tickets"
        - "Verify with change author"
        - "Confirm change was intentional"

  investigation:
    - step: 3
      action: "If unauthorized, determine method"
      owner: "Security Team"
      commands:
        - "Review authentication logs"
        - "Check for compromised credentials"
        - "Identify access path"

  containment:
    - step: 4
      action: "Revert unauthorized changes"
      owner: "Operations Team"
      commands:
        - "python scripts/revert_config.py --incident {{ incident_id }}"
        - "Verify system stability"

    - step: 5
      action: "Lock down configuration access"
      owner: "Security Team"
      commands:
        - "Review configuration permissions"
        - "Implement change approval workflow"
        - "Enable configuration audit logging"

  recovery:
    - step: 6
      action: "Verify system integrity"
      owner: "Operations Team"
      commands:
        - "Test system functionality"
        - "Monitor for anomalies"
        - "Validate configuration baseline"

  post_incident:
    - step: 7
      action: "Improve change management"
      owner: "Operations Team"
      commands:
        - "Implement configuration version control"
        - "Require peer review for changes"
        - "Add pre-change validation"

# =============================================================================
# System Compromise Playbook
# =============================================================================

system_compromise:
  name: "Suspected System Compromise"
  severity: CRITICAL
  response_time_sla: "Immediate"

  description: |
    Response procedures for suspected system compromise.
    Multiple indicators suggesting attacker has gained system access.

  detection_indicators:
    - Multiple critical security events
    - Unusual system behavior
    - Unauthorized processes or connections
    - File integrity violations

  immediate_actions:
    - step: 1
      action: "Isolate affected system"
      automated: true
      commands:
        - "Disconnect from network"
        - "Preserve volatile memory"
        - "Begin evidence collection"

    - step: 2
      action: "Activate incident response team"
      automated: true
      commands:
        - "Page security team"
        - "Alert CISO"
        - "Engage external forensics if needed"

  investigation:
    - step: 3
      action: "Forensic analysis"
      owner: "Security Team / Forensics Team"
      commands:
        - "Capture disk image"
        - "Analyze memory dump"
        - "Review system logs"
        - "Identify malware or backdoors"

    - step: 4
      action: "Determine scope"
      owner: "Security Team"
      commands:
        - "Identify entry point"
        - "Map lateral movement"
        - "Identify all compromised systems"
        - "Assess data exfiltration"

  containment:
    - step: 5
      action: "Isolate all compromised systems"
      owner: "Operations Team"
      commands:
        - "Segment network"
        - "Block attacker infrastructure"
        - "Revoke compromised credentials"

    - step: 6
      action: "Prevent further damage"
      owner: "Security Team"
      commands:
        - "Kill malicious processes"
        - "Block C2 communications"
        - "Prevent data exfiltration"

  eradication:
    - step: 7
      action: "Remove attacker presence"
      owner: "Security Team"
      commands:
        - "Remove malware"
        - "Delete backdoor accounts"
        - "Close exploited vulnerabilities"
        - "Patch all systems"

    - step: 8
      action: "Rebuild compromised systems"
      owner: "Operations Team"
      commands:
        - "Restore from clean backups"
        - "Or rebuild from scratch"
        - "Apply all security patches"
        - "Harden configurations"

  recovery:
    - step: 9
      action: "Restore operations gradually"
      owner: "Operations Team"
      commands:
        - "Bring systems online one by one"
        - "Verify no reinfection"
        - "Monitor closely for 30 days"

    - step: 10
      action: "Reset all credentials"
      owner: "Security Team"
      commands:
        - "Force password resets for all users"
        - "Rotate service account passwords"
        - "Regenerate API keys"
        - "Issue new certificates"

  post_incident:
    - step: 11
      action: "Comprehensive security review"
      owner: "Security Team"
      commands:
        - "Full security audit"
        - "Penetration testing"
        - "Architecture review"
        - "Implement compensating controls"

    - step: 12
      action: "Regulatory notification"
      owner: "Legal / Compliance"
      timeline: "72 hours for NIS2"
      commands:
        - "Notify regulatory authorities"
        - "Prepare breach notifications"
        - "Document incident response"

  escalation:
    triggers:
      - condition: "Detection"
        action: "Immediate CISO notification"
      - condition: "Data breach confirmed"
        action: "Activate crisis management team"
      - condition: "Ransomware detected"
        action: "Executive leadership notification"

# =============================================================================
# General Incident Response Workflow
# =============================================================================

general_workflow:
  phases:
    - phase: "Detection and Analysis"
      duration: "Variable"
      activities:
        - "Monitor security alerts"
        - "Analyze logs and events"
        - "Determine incident severity"
        - "Document initial findings"

    - phase: "Containment"
      duration: "Immediate to 4 hours"
      activities:
        - "Short-term containment (isolate affected systems)"
        - "Long-term containment (patch, harden)"
        - "Preserve evidence"
        - "Document actions taken"

    - phase: "Eradication"
      duration: "Hours to days"
      activities:
        - "Remove malware/backdoors"
        - "Fix vulnerabilities"
        - "Patch systems"
        - "Harden configurations"

    - phase: "Recovery"
      duration: "Hours to weeks"
      activities:
        - "Restore systems from clean backups"
        - "Verify system integrity"
        - "Monitor for reinfection"
        - "Return to normal operations"

    - phase: "Post-Incident Activity"
      duration: "1-2 weeks"
      activities:
        - "Document lessons learned"
        - "Update incident response procedures"
        - "Implement preventive measures"
        - "Provide training"

# =============================================================================
# Communication Templates
# =============================================================================

communication_templates:
  initial_notification:
    subject: "[{{ severity }}] Security Incident {{ incident_id }}"
    body: |
      A {{ severity }} security incident has been detected.

      Incident ID: {{ incident_id }}
      Time: {{ timestamp }}
      Category: {{ category }}

      Description:
      {{ description }}

      Current Status: {{ status }}
      Assigned To: {{ assigned_to }}

      Response SLA: {{ response_sla }}

      Next Steps:
      {{ next_steps }}

  status_update:
    subject: "UPDATE: {{ incident_id }} - {{ title }}"
    body: |
      Incident Status Update

      Incident ID: {{ incident_id }}
      Current Status: {{ status }}
      Last Updated: {{ updated_at }}

      Progress:
      {{ progress_summary }}

      Actions Taken:
      {{ actions_taken }}

      Next Steps:
      {{ next_steps }}

      Estimated Resolution: {{ estimated_resolution }}

  resolution_notification:
    subject: "RESOLVED: {{ incident_id }} - {{ title }}"
    body: |
      Incident Resolved

      Incident ID: {{ incident_id }}
      Resolved At: {{ resolved_at }}
      Resolution Time: {{ resolution_time }}

      Root Cause:
      {{ root_cause }}

      Resolution:
      {{ resolution }}

      Preventive Measures:
      {{ preventive_measures }}

      Lessons Learned:
      {{ lessons_learned }}
