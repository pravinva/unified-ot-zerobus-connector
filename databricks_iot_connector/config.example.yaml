# Databricks IoT Connector Configuration
# Example configuration for DMZ deployment

# Data sources (OPC-UA, MQTT, Modbus)
sources:
  # OPC-UA Example
  - name: "plant_opcua"
    endpoint: "opc.tcp://localhost:4840"
    protocol: "opcua"  # Auto-detected from endpoint
    variable_limit: 50
    publishing_interval_ms: 1000
    timeout: 5.0

  # MQTT Example
  - name: "sensors_mqtt"
    endpoint: "mqtt://localhost:1883"
    protocol: "mqtt"
    topics:
      - "factory/temperature/#"
      - "factory/pressure/#"
    qos: 1
    client_id: "dbx-connector"
    # username: "mqtt_user"
    # password: "${credential:mqtt.password}"
    payload_format: "auto"  # auto, json, string, bytes

  # Modbus TCP Example
  - name: "plc_modbus"
    endpoint: "modbus://localhost:502"
    protocol: "modbus"
    unit_id: 1
    poll_interval_ms: 1000
    registers:
      - type: "holding"
        address: 0
        count: 10
        name: "temperature"
        scale: 0.1
        offset: 0.0

# ZeroBus configuration (Databricks Unity Catalog streaming)
zerobus:
  # Databricks workspace
  workspace_host: "https://your-workspace.cloud.databricks.com"
  zerobus_endpoint: "https://your-workspace.cloud.databricks.com/api/2.0/streaming-ingest"

  # OAuth2 M2M authentication
  auth:
    client_id: "${credential:zerobus.client_id}"
    client_secret: "${credential:zerobus.client_secret}"

  # Target Unity Catalog table
  target:
    catalog: "main"
    schema: "iot_data"
    table: "sensor_readings"

  # Batch settings
  batch:
    max_records: 1000     # Batch size
    timeout_seconds: 5.0  # Max wait before flushing

  # Retry settings
  retry:
    max_attempts: 5
    initial_backoff_seconds: 1.0
    max_backoff_seconds: 300.0
    backoff_multiplier: 2.0

  # Circuit breaker
  circuit_breaker:
    failure_threshold: 5
    timeout_seconds: 60
    half_open_max_calls: 3

# Backpressure management
backpressure:
  # Memory queue
  max_queue_size: 10000

  # Disk spool (encrypted)
  spool_enabled: true
  spool_dir: "/var/lib/databricks-iot-connector/spool"
  spool_max_size_mb: 500
  spool_encryption_key: "${credential:backpressure.spool_key}"  # Auto-generated if not provided

  # Dead letter queue
  dlq_enabled: true
  dlq_dir: "/var/lib/databricks-iot-connector/dlq"

  # Drop policy when all queues full
  drop_policy: "oldest"  # oldest, newest, random

# Web GUI
web_gui:
  enabled: true
  host: "0.0.0.0"
  port: 8080

# Monitoring
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090

  # Health check
  health_check:
    enabled: true
    port: 8081

# Logging
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  format: "json"  # json, text
  file: "/var/log/databricks-iot-connector/connector.log"
  max_size_mb: 100
  backup_count: 5
